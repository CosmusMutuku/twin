name: Deploy Digital Twin

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      # --- Checkout code ---
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Configure AWS credentials ---
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-deploy
          aws-region: ${{ secrets.DEFAULT_AWS_REGION }}

      # --- Setup Python (for Lambda build) ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv (for deployment script)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # --- Setup Terraform ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      # --- Setup Node.js (for frontend) ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # --- Build frontend ---
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Build frontend
        run: npm run build
        working-directory: ./frontend

      # --- Initialize Terraform backend (non-interactive) ---
      - name: Initialize Terraform
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="key=twin-${{ github.event.inputs.environment || 'dev' }}/terraform.tfstate" \
            -backend-config="region=${{ secrets.DEFAULT_AWS_REGION }}" \
            -reconfigure

      # --- Deploy backend (Lambda, API Gateway, S3 memory bucket) ---
      - name: Run Deployment Script
        run: |
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh ${{ github.event.inputs.environment || 'dev' }}
        env:
          AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

      # --- Upload frontend to S3 ---
      - name: Upload frontend to S3
        run: |
          FRONTEND_BUILD_DIR=./frontend/dist   # use ./frontend/build if using CRA
          BUCKET_NAME=$(terraform -chdir=terraform output -raw s3_frontend_bucket)
          aws s3 sync $FRONTEND_BUILD_DIR s3://$BUCKET_NAME/ --delete
        env:
          AWS_REGION: ${{ secrets.DEFAULT_AWS_REGION }}

      # --- Get deployment URLs ---
      - name: Get Deployment URLs
        id: deploy_outputs
        working-directory: ./terraform
        run: |
          terraform workspace select ${{ github.event.inputs.environment || 'dev' }}
          echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "frontend_bucket=$(terraform output -raw s3_frontend_bucket)" >> $GITHUB_OUTPUT
          echo "frontend_url=$(terraform output -raw frontend_url)" >> $GITHUB_OUTPUT

      # --- Deployment Summary ---
      - name: Deployment Summary
        run: |
          echo "âœ… Deployment Complete!"
          echo "ğŸŒ Frontend (S3 website): ${{ steps.deploy_outputs.outputs.frontend_url }}"
          echo "ğŸ“¡ API Gateway: ${{ steps.deploy_outputs.outputs.api_url }}"
          echo "ğŸª£ Frontend Bucket: ${{ steps.deploy_outputs.outputs.frontend_bucket }}"
